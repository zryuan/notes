# Domain Name System DNS

## 简介

互联网的主机有两种标识：主机名和IP地址

主机名优点在于方便人们记忆且人们乐于接受，有意义。缺点在于因为主机名是不定长的，导致路由器难以解析和管理，无法定位主机在互联网中的位置。

IP地址优点在于定长32二进制位，便于路由器处理。缺点在于对人们来说没有任何意义且不便记忆。

所以为了折中就需要一个系统做主机名到IP地址的转换，这个系统就是DNS。

在应用层上使用的是域名，但是传递给下层的是经过DNS解析的IP地址。

## DNS 用途

1. 主要用途在于**主机名到IP地址的转换**
2. **主机别名**：主机除了主机名外，还可以拥有一个或者多个主机别名，就像人一样除了自己的名字外，可能还存在多个昵称。主机别名的好处在于相对于主机名，主机别名更有意义且好记。例如一台relay1.west-coast.enterprice.con的主机，可能还有两个别名enter-price.com和`www.enterprice.com`。这时主机名也被称为**规范主机名**，DNS提供主机别名到主机名转换。
3. **邮件服务器别名**：与主机别名一样，可以给邮件主机名取别名，DNS也提供邮件主机别名到邮件主机名的转换
4. **负载均衡**：DNS也用在冗余服务器之间进行负载均衡，可能一个服务部署在了多台服务器上，每个服务器都有自己的IP地址。那么意味着一个主机名可能映射多个IP地址，DNS数据库中存储着这些IP地址集合。当客户端发起DNS请求时，DNS会将该主机名对应的IP地址集合进行响应，但是每次DNS会对返回的IP地址集合的次序进行循环。因为客户端总是向IP地址集合中第一个IP地址发送请求，所以能做到一个负载均衡的效果。但是可能一些公司会通过DNS做更加复杂的负载均衡效果。

## DNS 工作原理概述

### DNS 域名结构

如果在一个层面命名设备会有很多重名

所以DNS采用层次树状结构的命名方法，每一个上层域都相当于一个命名空间，管理着下层域，以避免命名重复的问题。

树根之下是顶级域，顶级域下是二级域依次类推，每个域或子域下面都可以划分若干子域，树叶就是主机。

`顶级域列表可以查看参考引用部分`

<img src="images/image-20230629105757548.png" alt="image-20230629105757548" style="zoom:50%;" />

每一个域或主机都有自己的名字，是从底部往上拼接，每经过一个域则用点号进行分割。

例如：

robot对应的主机名就是robot.ai.cs.yale.edu.

cs对应的域名就是cs.yale.edu.

### DNS 服务器设计

DNS 的一种简单设计是在因特网上只使用一台服务器，这台服务器包含了所有的主机名到IP地址的映射记录。

这种集中式设计存在的问题在于：

1. 单点故障：该DNS服务器挂了，整个网络也就挂了
2. 通信容量：全球所有主机DNS查询请求都会发往这台主机
3. 远距离的集中式数据库：单个服务器是不可能临近所有用户的
4. 维护：所有更新都在一台服务器上，难以维护和扩展

因此DNS 服务器设计采用的是另一种方案：分层次的分布式

DNS使用了大量的DNS服务器，它们以**层次方式组织、分布在全球范围内**。

DNS服务器的分类：**根DNS服务器、顶级域（TLD）DNS服务器、权威DNS服务器**

这些类型的服务器以下图所以的层次组织起来。

<img src="images/image-20230628162648947.png" alt="image-20230628162648947" style="zoom:50%;" />

**根DNS服务器**：在全球有13个根DNS服务器（IPv4），标号A到M。我们说的一个根DNS服务器实际上是一个冗余的服务器群，以保证可靠性和安全性。

<img src="images/image-20230628163316160.png" alt="image-20230628163316160" style="zoom:50%;" />

根DNS服务器记录的是下层顶级域DNS服务器所在的位置，例如com，根DNS服务器返回就是com顶级域DNS服务器的IP集。

**顶级域（TLD）DNS服务器**：记录的是下层DNS服务器的IP集

**权威DNS服务器：**记录该组织或机构所有因特网可访问主机的主机名到IP地址映射的DNS记录。权威的概念是相对的，例如一个大学有一台DNS服务器，记录了本大学内所有的域名到IP地址映射的记录。对于其他想访问大学内的主机来说，大学的那台DNS服务器就是权威的，因为那是大学维护的。但是如果大学内的每一个系都有自己的DNS服务器，那么每一个系的DNS服务器才是权威服务器，而不是大学提供的DNS服务器。而大学DNS服务器可以认为是中间DNS服务器，记录了每一个系DNS服务器所在的位置。总结来说：权威服务器就是能直接提供域名到IP地址映射的DNS服务器。

可以看出DNS查询都是一层一层往下查询的。

除了以上DNS服务器外，还存在一个重要的DNS服务器，称为**本地DNS服务器**。本地DNS服务器严格意义上来说不属于DNS服务器层次结构。因为它主要作用是代理，代理客户端去查询DNS以及缓存。

当我们使用某个ISP提供的网络服务时，默认情况下（DHCP）都会指定一台或者多台本地DNS服务器的IP地址。而这些DNS服务器一般会跟你的主机在同一个局域网中，可以打开网络设置进行查看，如下：

<img src="images/image-20230628180947670.png" alt="image-20230628180947670" style="zoom:50%;" />

IP和DNS都采用DHCP进行默认分配，可以看出网关就是本地的DNS服务器。

使用本地DNS服务器的好处在于：

1. 缓存：当一个域名解析记录存在与本地DNS服务器时，那么指定了相同的本地DNS服务器的其他主机想要访问相同域名时就可以直接读取缓存。
2. 代理的好处在于可以做很多额外的事情，例如拦截等等。

### DNS 查询

DNS查询可以分为**递归查询和迭代查询**

**迭代查询：**

<img src="images/image-20230628182440961.png" alt="image-20230628182440961" style="zoom:50%;" />

1. 首先主机（cis.poly.edu.）想要获取某个主机名（gala.cs.umass.edu.）对应的IP，它会将DNS请求发送到本地DNS服务器上
2. 本地DNS服务器先查看自己是否缓存相对应主机名的IP，如果有则直接返回给请求主机，没有则请求根DNS服务器
3. 根DNS服务器会查询edu.这个顶级域名所对应的IP集，并返回给本地DNS服务器
4. 本地DNS服务器则会去请求edu.顶级DNS服务器
5. edu.顶级域名服务器则会去查询umass.edu.前缀，将对应DNS服务器的IP集返回。
6. 本地DNS服务器一直迭代的去请求其他DNS服务器，直到拿到想要的主机名所对应的IP。
7. 然后缓存，并将IP返回给客户端。

迭代查询请求实体一直都是本地的DNS服务器

**递归查询：**

<img src="images/image-20230628183830766.png" alt="image-20230628183830766" style="zoom:50%;" />

递归查询的请求实体就是一直变化的

### 资源记录

每一个DNS服务器都维护自己的**资源记录（Resource Record）**，它的字段格式：**（Name、TTL、Class、Type、Value）**

重点看下Type的值，因为type值不同导致Name和Value所代表的含义不同

Type表示资源记录的类型，常用的类型如下：

1. **Type=A**：那么Name表示主机名，Value表示主机名对应的IP地址，如果是IPv6则记录类型为AAAA。
2. **Type=NS**：那么Name表示域名，Value表示能解析该主机名的DNS服务器的主机名。
3. **Type=CNAME**：Name表示主机别名，Vlaue表示主机规范名，CNAME记录帮助查询主机别名所对应的主机规范名
4. **Type=MX**：与CNAME类型类似，MX记录表示的是邮箱的别名，所以 Name表示邮箱别名，Value表示邮箱规范名

一个例子：

<img src="images/image-20230629165619247.png" alt="image-20230629165619247" style="zoom:50%;" />

A记录：

flits.cs.vu.nl.	86400	IN	A	130.37.16.112

flits.cs.vu.nl.	86400	IN	A	192.31.231.165

一个主机名可以映射多个IP，那么查询到的多个A记录会一起返回，当然可能会涉及到一些负载均衡的算法。

一个IP也可能映射多个主机名，也就是多个主机名映射到了同一个IP上，例如假设：

flits.cs.vu.nl.	86400	IN	A	130.37.16.112

ftp.cs.vu.nl.	86400	IN	A	130.37.16.112



CNAME记录：

ftp.cs.vu.nl.	86400	IN	CNAME	zephyr.cs.vu.nl.

那么ftp.cs.vu.nl.就是zephyr.cs.vu.nl.的别名，每一个CNAME记录都会对应一个A记录，也就是zephyr.cs.vu.nl.的A记录。

然后这两条记录也会一并返回。所以就能知道所对应的IP地址



MX记录：

flits.cs.vu.nl.	86400	IN	MX	1 flits.cs.vu.nl.

flits.cs.vu.nl.	86400	IN	MX	2 zephyr.cs.vu.nl.

flits.cs.vu.nl.	86400	IN	MX	3 top.cs.vu.nl.

相同的邮箱别名可以存在多个MX记录，value值中有数字用来表示优先级，值越小表示优先级越高。`猜测也会一并返回，并且按照数字大小进行排序`

相应的每一个MX记录都会有一个对应的A记录，记录主机IP。



NS记录，上面的图没有NS记录，它大概如下：

sfn.cn.	86400	IN	NS	ns1.sfn.cn.

sfn.cn.	86400	IN	NS	ns2.sfn.cn.

NS记录也可能存在多个，表示该域存在多个DNS服务器，每一个NS记录都会对应一个A记录，这些记录也会一并返回。

前面说的CNAME、NS、MX记录都会有对应的A记录，这些A记录会一并返回给请求方。

**TTL（Time To Live**）：表示记录的生存时间，它决定了该记录的删除时间。在权威DNS服务器中维护了一些自己域中的记录，也缓存了一些学习到的记录。如果是自己域下的记录也被认为是**权威记录**，这种记录应该是永久保留或者是一个长期的值。而那些学习到被缓存下来的记录称为**缓存记录**，这种记录的TTL值一般较短（默认是两天），两天后该缓存记录就会被删除。缓存是为了性能，删除是为了保持一致性。

**Class**：表示资源的类别，IN表示Internet，也就是说DNS记录存在非因特网记录。

### 测试工具

在实际中我们可以使用一些工具命令查看DNS信息，例如：nslookup、dig

nslookup我在windows上可以直接使用，dig不能直接使用，需要进行下载安装，但是因为vc库版本不对，没有安装成功，暂时不管。

使用如下命令查看DNS缓存

```bash
nslookup -d www.baidi.com
```

打印结果：

![image-20230629212125561](images/image-20230629212125561.png)

```bash
nslookup -d -qt=mx www.qq.com
```

<img src="images/image-20230629213145464.png" alt="image-20230629213145464" />

### DNS 报文格式

![image-20230629213756943](images/image-20230629213756943.png)

DNS 请求报文和应答报文格式是一致的。

![image-20230629213909930](images/image-20230629213909930.png)

上面MX和A记录都是相同的主机名，那它是怎么知道要解析的是A记录还是MX记录，就是通过**问题区域的类型字段**。我们上面通过nslookup命令打印也能看到问题区域中有个type字段，可以搭配上面打印的截图来看报文的格式。

通过1标志位来区分是响应还是请求报文，因为DNS报文请求和响应是相同格式。

权威区域记录的是DNS解析所经过的权威DNS服务器，查看上图。

附加区域记录的是NS、MX等对应的A记录。



### DNS 解析过程-自己理解的

当一个应用程序需要域名到IP地址的转换时，它会调用DNS客户端也就是DNS解析器，并将要解析的域名和一些字段交给DNS解析器。

DNS解析器会先查看本地DNS缓存是否命中，如果名字则直接返回给应用程序。

如果没有则会去查看host文件是否有相关域名配置，有也是直接返回没有则会发起一个DNS请求到本地DNS服务器（系统默认指定的DNS服务器）上。

后续就是上面说的查询过程。







## 参考

[顶级域名列表](https://www.iana.org/domains/root/db)

[nslookup基本使用](https://blog.csdn.net/violet_echo_0908/article/details/52033725)

[dig基本使用](https://blog.csdn.net/jiajiren11/article/details/80071312)



