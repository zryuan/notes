# 网络层（Network）

## 简介

网络层数据包（IP数据包、Packet），由首部和数据两部分组成。

数据：数据部分是由上层传输层传递下来的数据段。

首部：首部为IP协议添加的额外信息，分为固定部分和可变部分。

​	固定部分为协议所规定的通信过程中肯定存在的字段部分，为20个字节。

![image-20230613173359393](image-20230613173359393.png)

## 首部

### 1、版本（Version）

版本字段占4个二进制位，用来表示当前使用的IP协议版本，例如IP4、IP6

<img src="image-20230613180310486.png" alt="image-20230613180310486"  />

### 2、首部长度

首部长度字段占4个二进制位，表示当前IP数据包首部占用长度，包括固定首部和可变首部长度。

![image-20230613180648920](image-20230613180648920.png)

首部长度计算：**长度 = 二进制值 * 4**

如上，**0101**二进制值为5，所以这个IP数据包的首部长度为20字节

**最小值**：固定部分长度20字节

最大值：**1111**值为15，所以最大值为60字节，也就是说可变部分最大值为40字节。

### 3、区分服务

区分服务字段占8个二进制位，主要用来通过区分不同服务，提高服务质量。

![image-20230613184000957](image-20230613184000957.png)

### 4、总长度（Total Length）

总长度字段占16个二进制位也就是两个字节，用来表示整个IP数据包的大小（长度）。

包括首部和数据部分，总体长度。

最大值：**2^16=65535**字节

![image-20230613182012676](image-20230613182012676.png)

在以太网中由于帧的数据部分不能超过1500字节，每个链路层协议都会规定自己的MTU（最大传输单元）。

所以过大的IP数据包，需要进行分片然后传输给数据链路层。

每一片都会有自己的网络层首部。

![image-20230613183055208](image-20230613183055208.png)

### 5、标识（Identification）

标识字段占16个二进制位，是该IP数据包的ID也就是唯一标识，用来标识该数据包的。

当数据包过大进行分片时，同一个数据包的所有片的标识都是一样的。

有一个计数器专门管理数据包ID，每发出一个数据包ID加1，当超过最大值65535时，自动从0开始。

![image-20230613194408167](image-20230613194408167.png)

### 6、标志（Flags）

占3位。

![image-20230613194718034](image-20230613194718034.png)

第一位（Reserved bit）：保留位

第二位（Don't fragment）：1代表不允许分片，0代表允许分片

第三位（More fragment）：1代表不是最后一片，0代表是最后一片

### 7、片偏移（Fragment Offets）

占13位。

片偏移乘以8等于字节偏移，也就是说片偏移的值乘以8后才是真正的字节偏移。

字节偏移指的是每一片中数据部分第一个字节相对于整个数据的偏移。如下图：

![image-20230613193745913](image-20230613193745913.png)

每一片数据部分长度都是8的整数倍

乘以8的原因：因为IP数据包总长度最大是16位，而13位的片偏移是不足以指定16位数据包的所有偏移值。补充3位后就一定能百分百覆盖整个数据包的所有字节。

![image-20230613194506631](image-20230613194506631.png)

#### 总结：

1、通过标识来确定多个帧是否是同一个IP数据包。

2、通过片偏移将同属于一个数据包的片进行组合。第一片值为0，第二片等于总长度减去首部长度得到数据部分长度

该值就是字节偏移值，除以8后在所有片中找寻片偏移等于该值的片。

3、通过标志知道那一片是最后一片，标志整个IP数据包组合完成。

